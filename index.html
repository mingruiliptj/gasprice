<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Japan Gasoline Prices Visualization</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://d3js.org/topojson.v3.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        h1 {
            text-align: center;
            color: #333;
        }
        .controls {
            margin: 20px 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        #year-slider {
            width: 300px;
        }
        .map-container {
            position: relative;
            width: 100%;
            height: 600px;
        }
        .prefecture {
            stroke: #fff;
            stroke-width: 0.5;
        }
        .prefecture:hover {
            stroke-width: 2;
            stroke: #333;
        }
        .legend {
            position: absolute;
            right: 20px;
            bottom: 20px;
            background: rgba(255,255,255,0.9);
            padding: 10px;
            border-radius: 4px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .prefecture-list {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            padding: 10px;
            margin-top: 10px;
        }
        .tooltip {
            position: absolute;
            background: rgba(0,0,0,0.8);
            color: white;
            padding: 5px 10px;
            border-radius: 3px;
            font-size: 12px;
            pointer-events: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Japan Gasoline Prices (2005-2025)</h1>
        <div class="controls">
            <div>
                <label for="year-slider">Year: </label>
                <input type="range" id="year-slider" min="2005" max="2025" value="2025">
                <span id="year-display">2025</span>
            </div>
            <button id="play-button">Play Animation</button>
            <div>
                <label>Filter Prefectures:</label>
                <div class="prefecture-list" id="prefecture-checkboxes"></div>
            </div>
        </div>
        <div class="map-container">
            <div id="map"></div>
            <div class="legend" id="legend"></div>
        </div>
    </div>

    <script>
        // Load both the map data and price data
        Promise.all([
            d3.json('https://raw.githubusercontent.com/dataofjapan/land/master/japan.topojson'),
            d3.json('data/gasoline_prices.json')
        ]).then(([japanMap, priceData]) => {
            const width = 800;
            const height = 600;
            const margin = { top: 20, right: 20, bottom: 20, left: 20 };

            // Create SVG
            const svg = d3.select('#map')
                .append('svg')
                .attr('width', width)
                .attr('height', height);

            // Create projection
            const projection = d3.geoMercator()
                .center([137, 38])
                .scale(1000)
                .translate([width / 2, height / 2]);

            const path = d3.geoPath().projection(projection);

            // Create color scale
            const colorScale = d3.scaleSequential(d3.interpolateReds)
                .domain([100, 200]); // Adjust based on your price range

            // Create tooltip
            const tooltip = d3.select('body').append('div')
                .attr('class', 'tooltip')
                .style('opacity', 0);

            // Draw the map
            const prefectures = topojson.feature(japanMap, japanMap.objects.japan);
            
            // Create a mapping function for prefecture names
            function getDisplayName(name) {
                return name.replace(/ (To|Fu|Ken)$/, '');
            }

            svg.selectAll('path')
                .data(prefectures.features)
                .enter()
                .append('path')
                .attr('class', 'prefecture')
                .attr('d', path)
                .attr('fill', d => {
                    const price = getPriceForPrefecture(d.properties.name, 2025);
                    return colorScale(price);
                })
                .on('mouseover', (event, d) => {
                    const price = getPriceForPrefecture(d.properties.name, 
                        document.getElementById('year-slider').value);
                    tooltip.transition()
                        .duration(200)
                        .style('opacity', .9);
                    tooltip.html(`${getDisplayName(d.properties.name)}<br/>Price: ¥${price}`)
                        .style('left', (event.pageX + 5) + 'px')
                        .style('top', (event.pageY - 28) + 'px');
                })
                .on('mouseout', () => {
                    tooltip.transition()
                        .duration(500)
                        .style('opacity', 0);
                });

            // Create legend
            const legendWidth = 200;
            const legendHeight = 20;

            const legendScale = d3.scaleLinear()
                .domain([100, 200])
                .range([0, legendWidth]);

            const legendAxis = d3.axisBottom(legendScale)
                .ticks(5)
                .tickFormat(d => `¥${d}`);

            const legend = d3.select('#legend')
                .append('svg')
                .attr('width', legendWidth + 40)
                .attr('height', legendHeight + 30);

            const defs = legend.append('defs');
            const linearGradient = defs.append('linearGradient')
                .attr('id', 'linear-gradient');

            linearGradient.selectAll('stop')
                .data(colorScale.ticks().map((t, i, n) => ({ 
                    offset: `${100*i/n.length}%`,
                    color: colorScale(t) 
                })))
                .enter()
                .append('stop')
                .attr('offset', d => d.offset)
                .attr('stop-color', d => d.color);

            legend.append('rect')
                .attr('width', legendWidth)
                .attr('height', legendHeight)
                .style('fill', 'url(#linear-gradient)');

            legend.append('g')
                .attr('transform', `translate(0,${legendHeight})`)
                .call(legendAxis);

            // Year slider functionality
            const yearSlider = document.getElementById('year-slider');
            const yearDisplay = document.getElementById('year-display');
            
            yearSlider.addEventListener('input', function() {
                yearDisplay.textContent = this.value;
                updateMap(this.value);
            });

            function updateMap(year) {
                svg.selectAll('.prefecture')
                    .transition()
                    .duration(200)
                    .attr('fill', d => {
                        const price = getPriceForPrefecture(d.properties.name, year);
                        return colorScale(price);
                    });
            }

            function getPriceForPrefecture(prefecture, year) {
                const data = priceData.find(d => 
                    d.prefecture === prefecture && d.year === parseInt(year)
                );
                return data ? data.price : 0;
            }

            // Animation functionality
            let animationInterval;
            const playButton = document.getElementById('play-button');
            
            playButton.addEventListener('click', function() {
                if (this.textContent === 'Play Animation') {
                    this.textContent = 'Stop Animation';
                    let year = parseInt(yearSlider.value);
                    
                    animationInterval = setInterval(() => {
                        year = year >= 2025 ? 2005 : year + 1;
                        yearSlider.value = year;
                        yearDisplay.textContent = year;
                        updateMap(year);
                    }, 1000);
                } else {
                    this.textContent = 'Play Animation';
                    clearInterval(animationInterval);
                }
            });

            // Create prefecture checkboxes
            const prefectureList = [...new Set(priceData.map(d => d.prefecture))];
            const checkboxContainer = document.getElementById('prefecture-checkboxes');
            
            prefectureList.forEach(prefecture => {
                const div = document.createElement('div');
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.id = prefecture;
                checkbox.checked = true;
                checkbox.addEventListener('change', function() {
                    const opacity = this.checked ? 1 : 0.2;
                    svg.selectAll('.prefecture')
                        .filter(d => d.properties.name === prefecture)
                        .transition()
                        .duration(200)
                        .style('opacity', opacity);
                });
                
                const label = document.createElement('label');
                label.htmlFor = prefecture;
                label.textContent = getDisplayName(prefecture);
                
                div.appendChild(checkbox);
                div.appendChild(label);
                checkboxContainer.appendChild(div);
            });
        });
    </script>
</body>
</html> 